---
name: Debbuilder Rules
description: Debbuilder flow, overrides, dependency policy, and image layout for DEB builds.
globs:
  - "debian/**/assets/build"
  - "ubuntu/**/assets/build"
  - "assets/build"
  - "assets/check-deps.sh"
  - "**/.debbuilder/**"
tags: ["debbuilder", "packaging", "debian", "ubuntu", "ci"]
priority: 5
version: 1.1.0
---

- Purpose: Debbuilder behavior, overrides, and conventions to streamline iteration.
- Scope: Applies in this repo only.

- Build flow (high level)
  - Detect packaging-only tree (no `./configure`, no `./src`). If so, fetch upstream sources.
  - Source of truth for fetching is `upstream.yml` in the repo root only (no `debian/watch`, no `debmacros` fallbacks).
  - `upstream.yml` keys:
    - `version`: upstream version string
    - `source`: URL template with placeholders `{version}` and optional `{name}`
  - The build script resolves the final URL by substituting placeholders, downloads with `curl -fsSL`, extracts, copies `debian/` into the source dir if needed, then builds via `dpkg-buildpackage`.
  - Artifacts (`.deb`, `.ddeb`, `.changes`, `.buildinfo`) are written to `/output`.

- Overrides for fast iteration
  - If `/.debbuilder/build` exists in the mounted `/sources` and is executable, it is executed instead of the image-bundled script.
  - This allows editing the build logic without rebuilding the image. Keep the interface identical to the built-in entrypoint.
  - Optionally extend this pattern for other tools (e.g., `/.debbuilder/check-deps.sh`) when needed.

- Source of truth and generated files
  - The single source of truth build script is `assets/build` at the repo root.
  - Per-distro copies at `debian/*/assets/build` and `ubuntu/*/assets/build` are generated artifacts (via internal tooling such as `crypt-keeper.sh`) and are `.gitignore`d.
  - Do not edit the generated per-suite scripts. Make changes to `assets/build` and regenerate.
  - If quick testing is needed without regeneration, use the runtime override `/.debbuilder/build` from the mounted source repo.

- Version stamping
  - `REVISION` is computed as a dist/flavor suffix only (no release), e.g., `gps1+deb12+stable`.
  - Packaging templates should set the release in `debian/changelog` as `1:VERSION-<release>~REVISION` (e.g., `-1~REVISION`).
  - The builder stamps placeholders `VERSION`, `REVISION`, and `SUITE_CODENAME` in `debian/changelog` when present.

- Dependency handling
  - Non-fatal preflight: run `check-deps.sh` to warn on missing build deps (parsed from `debian/control`).
  - Install build deps using: `mk-build-deps` → `apt-get build-dep` → manual parse fallback.
  - Always ensure base essentials like `pkg-config`, `libpcre2-dev`, `zlib1g-dev`, `libssl-dev` are present for nginx builds.
  - Ubuntu focal (20.04): before resolving deps, rewrite `debhelper-compat (= 13)` to `debhelper-compat (= 12)` (and `debian/compat` 13→12 when present). This avoids requiring backports and keeps builds green on focal.

- Idempotency and performance
  - A `.debbuilder_built` sentinel prevents duplicate builds within a single container run. Remove or use `--force` to rebuild.
  - Multi-package detection: if the repo contains multiple `debian/` trees (e.g., `nginx-<ver>`), build each once.

- Container images and layout
  - Images are tagged per distro codename (canonical) with numeric aliases.
  - Tag policy:
    - Canonical tags (preferred): hyphen-codename, e.g., `getpagespeed/debbuilder:ubuntu-jammy`, `debian-bookworm`
    - Numeric aliases:
      - Ubuntu dotted, e.g., `getpagespeed/debbuilder:ubuntu20.04`, `ubuntu22.04`, `ubuntu24.04`
      - Debian numeric, e.g., `getpagespeed/debbuilder:debian12`, `debian13`
  - Expected mounts: `-v $PWD:/sources`, `-v $PWD/output:/output`.
  - Non-interactive apt; lintian and devscripts are available in images.

- Matrix-driven configuration and mapping
  - `buildstrap-deb/matrix.yml` is the single source of truth for distros/versions:
    - Ubuntu `versions` are dotted strings `"20.04"`, `"22.04"`, `"24.04"`
    - Debian `versions` are numeric strings `"12"`, `"13"`
    - `codenames_map` maps numeric/dotted to codenames (e.g., `"22.04": jammy`, `"12": bookworm`)
  - `buildstrap-deb/generate_config.py` writes into this repo:
    - `matrix.json`: copy of matrix for local tooling
    - `defaults`: lines like `ubuntu jammy`, `debian bookworm` (used by `crypt-keeper.sh`)
    - `distro_versions.json`: GH Actions matrix entries with `{"os": "ubuntu", "version": "jammy"}`, etc.
    - `distmap.sh`: generated map from codename → numeric tag; sourced by `crypt-keeper.sh`
  - `crypt-keeper.sh`:
    - Sources `./distmap.sh` when present
    - Computes Docker tag for dist with `codename_to_numeric_tag` (Ubuntu yields dotted tags; Debian yields numeric)
    - Uses `docker buildx` to build and push for `linux/amd64, linux/arm64` with all aliases in one invocation

- Deploy and repository publishing
  - CI uses `DIST` (not `SUITE`) consistently. The deploy path is:
    `~/incoming-deb/${CIRCLE_PROJECT_REPONAME}/${DISTRO}/${DIST}/${ARCH}/${CIRCLE_BRANCH}/`
  - `builder-scripts/incoming-deb.sh` expects `<project>/<distro>/<dist>/<arch>/<branch>/`
    and runs `reprepro -b . includedeb "${DIST}" *.deb`.
  - `buildstrap-deb/generate_reprepro_distributions.py` generates `conf/distributions` suites
    using codenames as canonical suites (e.g., `jammy`, `bookworm`) and optional `-mainline` suites.
- Compression policy
  - `assets/build` exports `DPKG_DEB="dpkg-deb -Zxz -z9 --uniform-compression"` so every package’s `control.tar` stays gzip-compatible for the CentOS 7-based reprepro publisher.
  - Do not remove or override that environment variable unless the repo server has been upgraded to libarchive versions that support zstd-compressed control tarballs.

- Upstream sources
  - `upstream.yml` is the only source of truth for upstream version and tarball URL template.
  - No use of `debian/watch`, `uscan`, `debmacros` or `Homepage`/`Vcs-*` fallbacks during fetch.

- Local testing on Apple Silicon (Darwin arm64)
  - Prefer native arm64 execution for performance. Do not force `--platform linux/amd64`.
  - Example:
    - Good: `docker run --rm -v $PWD:/sources getpagespeed/debbuilder:ubuntu22.04 build`
    - Also acceptable: `docker run --rm --platform linux/arm64 ...`
  - Images are multi-arch; Docker will pull/run the arm64 variant on Apple Silicon by default.
